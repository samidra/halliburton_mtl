<div class="container-fluid">
    <div class="row p-1">
        <div class="col-12 form border-right">
            <h4>Search Filter</h4>
            <div class="d-flex border" style="display: flex; align-items: center;">
                <div style="border: 1px solid rgb(53, 53, 53);">
                    <div class="form_field">
                        <label for="">Start Date:</label>
                        <input type="date" [(ngModel)]="startDate" class="mt-1" placeholder="Start Date">
                        <label for="">End Date:</label>
                        <input type="date" [(ngModel)]="endDate" class="mt-1" placeholder="End Date">
                        <button type="button" class="date_search" (click)="filterByDateRange()">
                            Search
                        </button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between;width: 100%;">


                    <div class="form_field">
                        <label for="select_field">Select Filter Option: </label>
                        <select name="" id="select_field" (change)="getfilterselectedOption($event)">
                            <option value="Select Filter Option" selected>Select Filter Option</option>
                            <option *ngFor="let item of filterOptionList" [value]="item">
                                {{item}}
                            </option>
                        </select>
                    </div>
 
                    <div class="form_field" *ngIf="this.selectedFilterValue === 'Charge Code'">
                        <label for="chargeCode_search">Charge Code: </label>
                        <input type="text" id="chargeCode_search" [(ngModel)]="chargeCode_search"
                            placeholder="Search by Charge Code" (ngModelChange)="filteredAutocomplete()">
                    </div>

                    <div class="form_field" *ngIf="this.selectedFilterValue === 'Resource'">
                        <label for="Resource_search">Resource: </label>
                        <input type="text" id="Resource_search" [(ngModel)]="Resource_search"
                            placeholder="Search by Resource" (ngModelChange)="filteredAutocomplete()">
                    </div>

                    <div class="form_field" *ngIf="this.selectedFilterValue === 'Tool'">
                        <label for="Tool_search">Tool: </label>
                        <input type="text" id="Tool_search" [(ngModel)]="Tool_search" placeholder="Search by Tool"
                            (ngModelChange)="filteredAutocomplete()">
                    </div>

                    <!-- <div class="form_field" *ngIf="this.selectedFilterValue === 'PSL'">
                        <label for="psl_search">PSL: </label>
                        <input type="text" id="psl_search" [(ngModel)]="psl_search" placeholder="Search by PSL"
                            (ngModelChange)="filteredAutocomplete()">
                    </div> -->

                    <div class="form_field" *ngIf="this.selectedFilterValue === 'Group'">
                        <label for="group_search">Group: </label>
                        <input type="text" id="group_search" [(ngModel)]="group_search" placeholder="Search by Group"
                            (ngModelChange)="filteredAutocomplete()">
                    </div>

                    <div class="button_div" *ngIf="this.selectedFilterValue != 'Select Filter Option'">
                        <button type="button" class="draft_button" (click)="remove_filter()">
                            View All
                        </button>
                    </div>

                    <div style="display: flex; justify-content:flex-end; padding: 3px;">
                        <button class="yesbtn"
                            (click)="button_name === 'Expand All' ? expandAll():collapseAll()">{{button_name}}</button>
                        <button class="yesbtn mx-2" (click)="exportToExcel()">Export to Excel</button>
                    </div>

                </div>
            </div>

        </div>
        <div class="col-12 col_table">
            <table class="table table-bordered table-hover table-responsive">
                <thead class="table-light">

                    <tr>
                        <th>PSL</th>
                        <th>Test ID</th>
                        <th>Group</th>
                        <th>Resource</th>
                        <th>Tools</th>
                        <th>Description</th>
                        <th>Charge Code <br> Work Order</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Per Hour Rate</th>
                        <th>Total Hours</th>
                        <th>Total Cost</th>
                        <th>Activity Code</th>
                    </tr>
                </thead>

                <tbody>
                    <ng-container *ngFor="let psl of filteredTasks; let pslIndex = index">
                        <!-- PSL Row -->
                        <tr class="expandable" (click)="togglePSL(pslIndex)"
                            [ngStyle]="{'background-color': isPSLExpanded(pslIndex) ? '#d4e8fa' : '#e9ede8'}">
                            <td>
                                <i class="bi" [ngClass]="isPSLExpanded(pslIndex) ? 'bi-caret-down' : 'bi-caret-right'">
                                </i>
                                {{psl.psl}}
                            </td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>{{psl.hour}}</td>
                            <td>{{psl.cost}}</td>
                            <td>-</td>
                        </tr>

                        <ng-container *ngIf="expandedPSL.has(pslIndex)">
                            <ng-container *ngFor="let group of psl.data;">
                                <ng-container *ngFor="let tasks of group.taskNumbers;">
                                    <tr class="expandable" (click)="toggleTask(pslIndex, tasks[0]?.taskNumber)"
                                        [ngStyle]="{'background-color': isTaskExpanded(pslIndex, tasks[0]?.taskNumber) ? '#c9ffc7' : '#eef5ed'}">
                                        <td style="background-color: white !important;"></td>
                                        <td style="padding-left: 20px;">
                                            <i class="bi"
                                                [ngClass]="isTaskExpanded(pslIndex, tasks[0]?.taskNumber) ? 'bi-caret-down' : 'bi-caret-right'"
                                                style="margin-right: 6px;"></i>
                                            {{tasks[0]?.taskNumber}}
                                        </td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>{{tasks[0]?.perHourRate}}</td>
                                        <td>{{group.hour}}</td>
                                        <td>{{group.cost}}</td>
                                        <td>-</td>
                                    </tr>

                                    <ng-container *ngIf="isTaskExpanded(pslIndex, tasks[0]?.taskNumber)">
                                        <tr *ngFor="let task of tasks">
                                            <td></td>
                                            <td>
                                                <a (click)="routetoTaskInterface(tasks[0]?.taskNumber)"
                                                    style="color:rgb(3, 3, 212); font-weight: 700; font-size: 1.1em; cursor: pointer;">
                                                    {{tasks[0]?.taskNumber}}
                                                </a>
                                            </td>
                                            <td>{{task.group}}</td>
                                            <td>{{task.resource}}</td>
                                            <td>{{task.tool}}</td>
                                            <td>{{task.description}}</td>
                                            <td>{{task.charge_Code}}</td>
                                            <td>{{task.startDate?.split("T")[0]}}</td>
                                            <td>{{task.endDate?.split("T")[0]}}</td>
                                            <td>{{task.perHourRate}}</td>
                                            <td>{{task.hour}}</td>
                                            <td>{{task.cost}}</td>
                                            <td>{{task.activity_Code}}</td>
                                        </tr>
                                    </ng-container>
                                </ng-container>
                            </ng-container>
                        </ng-container>
                    </ng-container>
                </tbody>

                <tfoot>
                    <tr>
                        <td [attr.colspan]="13" class="text-end p-2">
                            Total: {{ totalRecords }} records across {{ totalPSLs }} PSLs |
                            Grand Total: ${{ grandTotal | number:'1.0-0' }}
                        </td>
                    </tr>
                </tfoot>
                
            </table>
        </div>
    </div>
</div>

<div class="loader" *ngIf="isLoading">
    <div class="spinner"></div>
</div>